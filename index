<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CryptoAnalysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://s3.tradingview.com/tv.js"></script>
  <link rel="icon" href="https://via.placeholder.com/48/0d6efd/ffffff?text=CA" type="image/png">
  <style>
    :root { --bs-body-bg: #0d1117; --bs-body-color: #e6edf3; }
    body {scroll-margin-top:4rem;}
    .navbar-brand img{height:34px;margin-right:.4rem}
    section{padding-top:4rem;padding-bottom:4rem}
    footer{background:#010409;color:#8b949e;padding:1rem 0;font-size:.9rem}
    table img{width:20px;height:20px;margin-right:6px;border-radius:50%}
    .tv-widget{min-height:500px}
  </style>
</head>
<body>
<!-- content omitted for brevity -->
<script>
/* ---------- Helper Functions ---------- */
const $ = sel => document.querySelector(sel);
const abbreviate = n => n >= 1e12 ? (n/1e12).toFixed(2)+'T'
  : n >= 1e9 ? (n/1e9).toFixed(2)+'B'
  : n >= 1e6 ? (n/1e6).toFixed(2)+'M'
  : n.toLocaleString();

/* ---------- Load Markets ---------- */
async function loadMarkets(){
  const tbody = $('#market-table tbody');
  tbody.innerHTML='<tr><td colspan="5">Loading…</td></tr>';
  try{
    const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10');
    const data = await res.json(); tbody.innerHTML='';
    data.forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td><img src="${c.image}" alt="">${c.name} (${c.symbol.toUpperCase()})</td>
        <td>$${c.current_price.toLocaleString()}</td>
        <td class="${c.price_change_percentage_24h>=0?'text-success':'text-danger'}">
            ${c.price_change_percentage_24h.toFixed(2)}%
        </td>
        <td>$${abbreviate(c.market_cap)}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){tbody.innerHTML='<tr><td colspan="5">Failed.</td></tr>';console.error(e);}
}

/* ---------- Load News ---------- */
async function loadNews(){
  const list = $('#news-list');
  list.innerHTML='<p>Loading news…</p>';
  const apiKey = '8d046029316d297e21a5de6ad98c7461'; // ← مفتاح GNews الخاص بك
  if(apiKey==='REPLACE_WITH_YOUR_GNEWS_KEY'){list.innerHTML='<p class="text-warning">Add your GNews API key in the code.</p>';return;}
  try{
    const res=await fetch(`https://gnews.io/api/v4/search?q=crypto&lang=en&token=${apiKey}`);
    const {articles}=await res.json(); list.innerHTML='';
    articles.slice(0,6).forEach(a=>{
      const col=document.createElement('div');col.className='col-md-4';
      col.innerHTML=`<div class="card bg-dark border-secondary h-100 p-3">
        <h6><a href="${a.url}" target="_blank" class="stretched-link text-info">${a.title}</a></h6>
        <small>${new Date(a.publishedAt).toLocaleDateString()}</small>
      </div>`;
      list.appendChild(col);
    });
  }catch(e){list.innerHTML='<p>Failed to load news.</p>';console.error(e);}
}

/* ---------- TradingView Chart ---------- */
function loadChart(){
  new TradingView.widget({
    container_id:"tv-chart",
    symbol:"BINANCE:BTCUSDT",
    interval:"D",
    autosize:true,
    theme:"dark",
    locale:"en",
    hide_legend:false,
    allow_symbol_change:true,
    studies:["MACD@tv-basicstudies"]
  });
}

/* ---------- Referral ----------- */
function setupReferral(){
  const code=Math.random().toString(36).substr(2,8).toUpperCase();
  $('#ref-link').value=`${location.origin+location.pathname}?ref=${code}`;
  $('#copy-btn').onclick=()=>{
    navigator.clipboard.writeText($('#ref-link').value).then(()=>{
      $('#copy-msg').classList.remove('d-none');
      setTimeout(()=>$('#copy-msg').classList.add('d-none'),1500);
    });
  };
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  loadMarkets(); loadNews(); loadChart(); setupReferral();
});
</script>
</body>
</html>